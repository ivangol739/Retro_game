!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(t=e,a=this.boardSize,0===t?"top-left":t>0&&t<a-1?"top":t===a-1?"top-right":t===a**2-a?"bottom-left":t===a**2-1?"bottom-right":t>a**2-a&&t<a**2-1?"bottom":t%a==0?"left":(t+1)%a==0?"right":"center")),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t,a;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const r=document.createElement("div");r.classList.add("health-level");const i=document.createElement("div");i.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),i.style.width=`${a.character.health}%`,r.appendChild(i),s.appendChild(r),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],r=document.createElement("span");r.textContent=t,r.classList.add("damage"),s.appendChild(r),r.addEventListener("animationend",(()=>{s.removeChild(r),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class t{constructor(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(new.target.name===t)throw new Error("Impossible create instance");this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=a}}class a extends t{constructor(e){super(e,"daemon"),this.attack=10,this.defence=10,this.movesAttack=1,this.Moves=4}}class s extends t{constructor(e){super(e,"undead"),this.attack=40,this.defence=10,this.movesAttack=1,this.Moves=4}}class r extends t{constructor(e){super(e,"vampire"),this.attack=25,this.defence=25,this.movesAttack=2,this.Moves=2}}class i{constructor(e,a){if(!(e instanceof t))throw new Error("character must be instance of Character or its children");if("number"!=typeof a)throw new Error("position must be a number");this.character=e,this.position=a}}class l{static from(e){return this.level=e.level,this.character=e.character,this.step=e.step,this.state=e.state,this.possibleMoves=e.possibleMoves,this.possibleAttack=e.possibleAttack,this.itemPlayer=e.itemPlayer,this.itemComputer=e.itemComputer,this.scores=e.scores,this.maxLevel=e.maxLevel,this.saveGame=[{level:this.level,character:this.character,step:this.step,scores:this.scores,maxLevel:this.maxLevel}],null}}function c(e,t,a){const s=function*(e,t){for(;;){const a=Object.create(e[Math.floor(Math.random()*e.length)]);a.level=Math.floor(Math.random()*t)+1,yield a}}(e,t),r=[];for(let e=0;e<a;e+=1){const t=s.next().value;t.attack=t.__proto__.attack,t.defence=t.__proto__.defence,t.health=t.__proto__.health,t.type=t.__proto__.type,t.movesAttack=t.__proto__.movesAttack,t.Moves=t.__proto__.Moves,r[e]=t}return r}function n(e){for(let t=e.length-1;t>0;t-=1){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e}class o{constructor(e,t,i){this.characterCount=e,this.maxLevel=t,this.typesPlayer=i,this.typesComputer=[new a,new s,new r],this.positionPlayer=[0,1,8,9,16,17,24,25,32,33,40,41,48,49,56,57],this.positionComputer=[6,7,14,15,22,23,30,31,38,39,46,47,54,55,62,63]}lvlUp(){const e=[],t=c(this.typesPlayer,this.maxLevel,this.characterCount);if(l.character)for(l.character.forEach((e=>{e.character.level+=1,e.character.defence=Math.round(Math.max(e.character.defence,e.character.defence*(1.8-(1-e.character.health/100)))),e.character.attack=Math.round(Math.max(e.character.attack,e.character.attack*(1.8-(1-e.character.health/100)))),e.character.health+=80,e.character.health>100&&(e.character.health=100),t.push(e.character)}));t.length>10;)t.shift();const a=n(this.positionPlayer);for(let s=0;s<=t.length-1;s+=1)e.push(new i(t[s],a[s]));const s=c(n(this.typesComputer),this.maxLevel,t.length),r=n(this.positionComputer);for(let t=0;t<=s.length-1;t+=1)e.push(new i(s[t],r[t]));return e}}var h={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"},d="pointer",m="crosshair",p="not-allowed";class v extends t{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.movesAttack=2,this.Moves=2}}class u extends t{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.movesAttack=1,this.Moves=4}}class y extends t{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.movesAttack=4,this.Moves=1}}class f{constructor(e,t){this.gamePlay=e,this.stateService=t}init(){l.character=null,l.from({level:1,character:new o(2,1,[new u,new v,new y]).lvlUp(),step:"player",state:null,scores:0,maxLevel:1}),this.gamePlay.drawUi(`${Object.values(h)[l.level-1]}`),this.gamePlay.redrawPositions(l.character),this.gamePlay.addNewGameListener(this.init.bind(this)),this.gamePlay.addLoadGameListener(this.onLoad.bind(this)),this.gamePlay.addSaveGameListener(this.onSave.bind(this)),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this))}onSave(){l.from({level:l.level,character:l.character,scores:l.scores,maxLevel:l.maxLevel}),this.stateService.storage.clear(),this.stateService.save(l.saveGame)}onLoad(){const e=this.stateService.load();l.from({level:e[0].level,character:e[0].character,step:e[0].step,scores:e[0].scores,maxLevel:e[0].maxLevel}),this.gamePlay.drawUi(`${Object.values(h)[l.level-1]}`),this.gamePlay.redrawPositions(e[0].character)}onCellClick(t){function a(e){return e.position===t&&("daemon"===e.character.type||"undead"===e.character.type||"vampire"===e.character.type)}const s=l.character.findIndex(a),r=l.character.find((function(e){return e.position===t&&("bowman"===e.character.type||"magician"===e.character.type||"swordsman"===e.character.type)})),i=l.character.find(a);if("computer"===l.step)this.com();else if(r)l.itemPlayer=r,l.possibleAttack=f.possible(r.character.movesAttack,t),l.possibleMoves=f.possible(r.character.Moves,t),l.state||0===l.state?(this.gamePlay.deselectCell(l.state),l.state=t,this.gamePlay.selectCell(t)):(this.gamePlay.selectCell(t),l.state=t);else if(!r&&!i&&l.possibleMoves&&l.possibleMoves.includes(t))l.itemPlayer.position=t,this.gamePlay.redrawPositions(l.character),this.gamePlay.deselectCell(l.state),this.gamePlay.deselectCell(t),l.state=null,l.itemPlayer=null,l.possibleAttack=null,l.possibleMoves=null,l.step="computer",this.onCellClick(t);else if(i&&l.possibleAttack&&l.possibleAttack.includes(t)){const e=Math.round(Math.max(l.itemPlayer.character.attack-i.character.defence,.1*l.itemPlayer.character.attack));l.itemComputer=i,l.itemComputer.character.health-=e,this.gamePlay.showDamage(t,e).then((()=>{this.gamePlay.deselectCell(l.state),this.gamePlay.deselectCell(t),l.itemComputer.character.health<=0&&l.character.splice(s,1),this.gamePlay.redrawPositions(l.character),l.state=null,l.itemPlayer=null,l.possibleAttack=null,l.possibleMoves=null,l.step="computer",this.onCellClick(t)}))}else e.showError("Недопустимый ход...")}onCellEnter(e){l.character.forEach((t=>{if(t.position===e){const a=`${String.fromCodePoint(127894)} ${t.character.level} ${String.fromCodePoint(9876)} ${t.character.attack} ${String.fromCodePoint(128737)} ${t.character.defence} ${String.fromCodePoint(10084)} ${t.character.health}`;this.gamePlay.showCellTooltip(a,e),"bowman"!==t.character.type&&"magician"!==t.character.type&&"swordsman"!==t.character.type||this.gamePlay.setCursor(d)}}));const t=l.character.find((function(t){return t.position===e&&("vampire"===t.character.type||"undead"===t.character.type||"daemon"===t.character.type)}));l.possibleMoves&&l.possibleMoves.includes(e)&&l.state!==e&&!t&&(this.gamePlay.setCursor(d),this.gamePlay.selectCell(e,"green")),t&&l.possibleAttack&&l.possibleAttack.includes(e)&&(this.gamePlay.setCursor(m),this.gamePlay.selectCell(e,"red"))}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(p),this.gamePlay.deselectCell(e),l.state&&this.gamePlay.selectCell(l.state)}static possible(e,t){const a=[];for(let s=0;s<=2*e;s+=1){let r=t-9*e+8*s;const i=t-8*e+8*s;for(let t=0;t<=2*e;t+=1)Math.trunc(r/8)===Math.trunc(i/8)&&r>=0&&r<=63?a.push(r++):r++}return a}com(){const t=[],a=[];let s=[];if(l.character.forEach((e=>{"vampire"!==e.character.type&&"undead"!==e.character.type&&"daemon"!==e.character.type||t.push(e)})),l.character.forEach((e=>{"bowman"!==e.character.type&&"magician"!==e.character.type&&"swordsman"!==e.character.type||a.push(e)})),0===t.length){let t;a.forEach((e=>{l.scores+=e.character.health})),e.showMessage(`Количество очков: ${l.scores}!`),l.step="player",this.gamePlay.cellClickListeners=[],this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.newGameListeners=[],this.gamePlay.saveGameListeners=[],this.gamePlay.loadGameListeners=[],l.level+=1,l.maxLevel+=1,l.level>4&&(l.level=1),t=1===l.level||2===l.level?1:2;const s=new o(t,l.maxLevel,[new v,new y,new u]).lvlUp();return l.character=s,this.gamePlay.drawUi(`${Object.values(h)[l.level-1]}`),this.gamePlay.redrawPositions(l.character),this.gamePlay.addNewGameListener(this.init.bind(this)),this.gamePlay.addLoadGameListener(this.onLoad.bind(this)),this.gamePlay.addSaveGameListener(this.onSave.bind(this)),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),void this.gamePlay.addCellClickListener(this.onCellClick.bind(this))}const[r]=n(t);if(a.forEach((e=>{f.possible(r.character.movesAttack,r.position).find((t=>t===e.position))&&s.push(e)})),s.length>0){[s]=n(s);const t=Math.round(Math.max(r.character.attack-s.character.defence,.1*r.character.attack));s.character.health-=t,this.gamePlay.showDamage(s.position,t).then((()=>{if(s.character.health<=0&&(l.character.splice(l.character.indexOf(s),1),1===a.length))return e.showMessage(`Вы набрали очков: ${l.scores}!. Нажмите начать новую игру.`),void this.gamePlay.redrawPositions(l.character);this.gamePlay.redrawPositions(l.character)}))}else{const e=n(f.possible(r.character.Moves,r.position));[...a,...t].forEach((t=>{f.possible(r.character.Moves,r.position).find((e=>e===t.position))&&e.splice(e.indexOf(t.position),1)})),r.position=e[0],this.gamePlay.redrawPositions(l.character)}l.step="player"}}const L=new e;L.bindToDOM(document.querySelector("#game-container"));const g=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage);new f(L,g).init()}();